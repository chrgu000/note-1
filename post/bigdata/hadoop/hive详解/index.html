<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>hive详解</title>
<meta name="description" content=" John Doe&#39;s Personal blog about everything">
<meta name="generator" content="Hugo 0.17" />
<meta property="og:title" content="hive详解" />
<meta property="og:description" content="hive详解1. Hive简介1.1. 什么是Hive1.2. 为什么使用Hive1.3. Hive的特点2. Hive 架构2.1. 基本组成2.2. 各组件的基本功能3. Hive与Hadoop的关系4. Hive与传统数据库对比4.1. 对比5. Hive的数据存储6. HIVE 的安装部署6.1. 使用方式7. Hive基本操作7.1. DDL操作7.1.1. 创建表具体实例7.1.2. 修改表增加/删除分区重命名表增加/更新列显示命令7.1.3. DML操作LoadInsertSELECT7.1.4. Hive Join1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://dishui.oschina.io/note-hugo/post/bigdata/hadoop/hive%E8%AF%A6%E8%A7%A3/" />


<meta property="og:updated_time" content="2017-03-17T00:00:00&#43;00:00"/>











<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/google-font.css?family=Open+Sans:400,400italic,700,600" type="text/css" media="all" />
<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/atom-one-dark.css">
<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/style.css" type="text/css" media="all" />
<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/custom.css" type="text/css" media="all" />
<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/jquery.bigautocomplete.css" type="text/css" media="all" />
<link rel="stylesheet" href="http://dishui.oschina.io/note-hugo/css/jquery.tocify.css" type="text/css" media="all" />
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/fonts/fontawesome-webfont.svg" rel="stylesheet">

<script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/javascript" src="http://dishui.oschina.io/note-hugo/js/scripts.js"></script>
<!--[if lt IE 9]>
	<script src="http://dishui.oschina.io/note-hugo/js/css3-mediaqueries.js"></script>
<![endif]-->

<script data-main="http://dishui.oschina.io/note-hugo/js/app.js" src="http://dishui.oschina.io/note-hugo/js/require.js"></script>

</head>
<body id="mr-mobile" class="home blog mr-right-sb" itemscope="itemscope" itemtype="http://schema.org/WebPage">
	<div class="mr-container mr-container-outer">
		<div class="mr-header-mobile-nav clearfix"></div>
			<header class="mr-header" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
				<div class="mr-container mr-container-inner mr-row clearfix">
					<div class="mr-custom-header clearfix">
						<div class="mr-site-identity">
							<div class="mr-site-logo" role="banner" itemscope="itemscope" itemtype="http://schema.org/Brand">
								<div class="mr-header-text">
									<a class="mr-header-text-link" href="http://dishui.oschina.io/note-hugo/" title="工作笔记" rel="home">
										<h1 class="mr-header-title">工作笔记</h1>
										<h2 class="mr-header-tagline">点滴记录</h2>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="mr-main-nav-wrap">
					<nav class="menu" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
	<ul class="menu__list">
		
	</ul>
</nav>
				</div>
			</header>
		<div class="mr-wrapper clearfix">


<div class="mr-content" id="main-content" role="main" itemprop="mainContentOfPage">
	<article class="post">
		<header class="entry-header clearfix">
			<h1 class="entry-title">hive详解</h1>
			<p class="mr-meta entry-meta">
				<svg class="icon icon-time" height="14" viewBox="0 0 16 16" width="14" xmlns="http://www.w3.org/2000/svg"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
				<time class="entry-meta-date updated" datetime="2017-03-17 00:00:00 &#43;0000 UTC">March 17, 2017</time>
				<span class="entry-meta-categories">
					<svg class="icon icon-category" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
					<a class="meta-categories" href="/note-hugo/categories/hadoop" rel="category">hadoop</a></span>
			</p>
		</header>
		<div class="entry-content clearfix">
			
			<div id="toc" class="toc">
<div id="toctitle">hive详解</div>
<ul class="sectlevel1">
<li><a href="#_hive简介">1. Hive简介</a>
<ul class="sectlevel2">
<li><a href="#_什么是hive">1.1. 什么是Hive</a></li>
<li><a href="#_为什么使用hive">1.2. 为什么使用Hive</a></li>
<li><a href="#_hive的特点">1.3. Hive的特点</a></li>
</ul>
</li>
<li><a href="#__strong_hive_strong_架构">2. <strong>Hive</strong> 架构</a>
<ul class="sectlevel2">
<li><a href="#_基本组成">2.1. 基本组成</a></li>
<li><a href="#_各组件的基本功能">2.2. 各组件的基本功能</a></li>
</ul>
</li>
<li><a href="#_hive与hadoop的关系">3. Hive与Hadoop的关系</a></li>
<li><a href="#_hive与传统数据库对比">4. Hive与传统数据库对比</a>
<ul class="sectlevel2">
<li><a href="#_对比">4.1. 对比</a></li>
</ul>
</li>
<li><a href="#_hive的数据存储">5. Hive的数据存储</a></li>
<li><a href="#__strong_hive_strong_的安装部署">6. <strong>HIVE</strong> 的安装部署</a>
<ul class="sectlevel2">
<li><a href="#_使用方式">6.1. 使用方式</a></li>
</ul>
</li>
<li><a href="#_hive基本操作">7. Hive基本操作</a>
<ul class="sectlevel2">
<li><a href="#_ddl操作">7.1. DDL操作</a>
<ul class="sectlevel3">
<li><a href="#_创建表">7.1.1. 创建表</a>
<ul class="sectlevel4">
<li><a href="#_具体实例">具体实例</a></li>
</ul>
</li>
<li><a href="#_修改表">7.1.2. 修改表</a>
<ul class="sectlevel4">
<li><a href="#_增加_删除分区">增加/删除分区</a></li>
<li><a href="#_重命名表">重命名表</a></li>
<li><a href="#_增加_更新列">增加/更新列</a></li>
<li><a href="#_显示命令">显示命令</a></li>
</ul>
</li>
<li><a href="#_dml操作">7.1.3. DML操作</a>
<ul class="sectlevel4">
<li><a href="#_load">Load</a></li>
<li><a href="#_insert">Insert</a></li>
<li><a href="#_select">SELECT</a></li>
</ul>
</li>
<li><a href="#_hive_join">7.1.4. Hive Join</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_hive简介">1. Hive简介</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_什么是hive">1.1. 什么是Hive</h3>
<div class="paragraph">
<p>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。</p>
</div>
</div>
<div class="sect2">
<h3 id="_为什么使用hive">1.2. 为什么使用Hive</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">直接使用hadoop所面临的问题 </dt>
<dd>
<p>人员学习成本太高<br>
项目周期要求太短<br>
MapReduce实现复杂查询逻辑开发难度太大</p>
</dd>
<dt class="hdlist1">为什么要使用Hive </dt>
<dd>
<p>避免了去写MapReduce，减少开发人员的学习成本。+
扩展功能很方便。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_hive的特点">1.3. Hive的特点</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">可扩展 </dt>
<dd>
<p>Hive可以自由的扩展集群的规模，一般情况下不需要重启服务。</p>
</dd>
<dt class="hdlist1">延展性 </dt>
<dd>
<p>Hive支持用户自定义函数，用户可以根据自己的需求来实现自己的函数。</p>
</dd>
<dt class="hdlist1">容错 </dt>
<dd>
<p>良好的容错性，节点出现问题SQL仍可完成执行</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__strong_hive_strong_架构">2. <strong>Hive</strong> 架构</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/2017-03-17_155621.png" alt="2017 03 17 155621">
</div>
</div>
<hr>
<div class="dlist">
<dl>
<dt class="hdlist1">Jobtracker </dt>
<dd>
<p>hadoop1.x中的组件，它的功能相当于： Resourcemanager+AppMaster</p>
</dd>
<dt class="hdlist1">TaskTracker </dt>
<dd>
<p>相当于：  Nodemanager  +  yarnchild</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="_基本组成">2.1. 基本组成</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">用户接口</dt>
<dd>
<p>包括 CLI、JDBC/ODBC、WebGUI。</p>
</dd>
<dt class="hdlist1">元数据存储</dt>
<dd>
<p>通常是存储在关系数据库如 mysql,derby中。</p>
</dd>
<dt class="hdlist1">解释器、编译器、优化器、执行器</dt>
<dd>
<p>-</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_各组件的基本功能">2.2. 各组件的基本功能</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">用户接口主要由三个</dt>
<dd>
<p>CLI、JDBC/ODBC和WebGUI。其中，CLI为shell命令行；JDBC/ODBC是Hive的JAVA实现，与传统数据库JDBC类似；WebGUI是通过浏览器访问Hive。</p>
</dd>
<dt class="hdlist1">元数据存储 </dt>
<dd>
<p>Hive 将元数据存储在数据库中。Hive 中的元数据包括表的名字，表的列和分区及其属性，表的属性（是否为外部表等），表的数据所在目录等。</p>
</dd>
<dt class="hdlist1">解释器、编译器、优化器 </dt>
<dd>
<p>完成 HQL 查询语句从词法分析、语法分析、编译、优化以及查询计划的生成。生成的查询计划存储在 HDFS 中，并在随后有 MapReduce 调用执行。</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hive与hadoop的关系">3. Hive与Hadoop的关系</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Hive利用HDFS存储数据，利用MapReduce查询数据</p>
</div>
</blockquote>
</div>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/2017-03-17_160404.png" alt="2017 03 17 160404">
</div>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_hive与传统数据库对比">4. Hive与传统数据库对比</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/2017-03-17_160454.png" alt="2017 03 17 160454">
</div>
</div>
<hr>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>总结：hive具有sql数据库的外表，但应用场景完全不同，hive只适合用来做批量数据统计分析</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_对比">4.1. 对比</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>查询语言。由于 SQL 被广泛的应用在数据仓库中，因此，专门针对 Hive 的特性设计了类 SQL 的查询语言 HQL。熟悉 SQL 开发的开发者可以很方便的使用 Hive 进行开发。</p>
</li>
<li>
<p>数据存储位置。Hive 是建立在 Hadoop 之上的，所有 Hive 的数据都是存储在 HDFS 中的。而数据库则可以将数据保存在块设备或者本地文件系统中。</p>
</li>
<li>
<p>数据格式。Hive 中没有定义专门的数据格式，数据格式可以由用户指定，用户定义数据格式需要指定三个属性：列分隔符（通常为空格、”\t”、”\x001″）、行分隔符（”\n”）以及读取文件数据的方法（Hive 中默认有三个文件格式 TextFile，SequenceFile 以及 RCFile）。由于在加载数据的过程中，不需要从用户数据格式到 Hive 定义的数据格式的转换，因此，Hive 在加载的过程中不会对数据本身进行任何修改，而只是将数据内容复制或者移动到相应的 HDFS 目录中。而在数据库中，不同的数据库有不同的存储引擎，定义了自己的数据格式。所有数据都会按照一定的组织存储，因此，数据库加载数据的过程会比较耗时。</p>
</li>
<li>
<p>数据更新。由于 Hive 是针对数据仓库应用设计的，而数据仓库的内容是读多写少的。因此，Hive 中不支持对数据的改写和添加，所有的数据都是在加载的时候中确定好的。而数据库中的数据通常是需要经常进行修改的，因此可以使用 INSERT INTO &#8230;&#8203;  VALUES 添加数据，使用 UPDATE &#8230;&#8203; SET 修改数据。</p>
</li>
<li>
<p>索引。之前已经说过，Hive 在加载数据的过程中不会对数据进行任何处理，甚至不会对数据进行扫描，因此也没有对数据中的某些 Key</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hive的数据存储">5. Hive的数据存储</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Hive</strong> 中所有的数据都存储在 <strong>HDFS</strong>  中，没有专门的数据存储格式（可支持*Text* ，<strong>SequenceFile</strong> ，<strong>ParquetFile</strong> ，<strong>RCFILE</strong> 等）</p>
</li>
<li>
<p>只需要在创建表的时候告诉 <strong>Hive</strong>  数据中的列分隔符和行分隔符，<strong>Hive</strong>  就可以解析数据。</p>
</li>
<li>
<p><strong>Hive</strong>  中包含以下数据模型：<strong>DB</strong> 、<strong>Table</strong> ，<strong>External</strong>  <strong>Table</strong> ，<strong>Partition</strong> ，<strong>Bucket</strong> 。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>db</strong> ：在 <strong>hdfs</strong> 中表现为${<strong>hive</strong> .<strong>metastore</strong> .<strong>warehouse</strong> .<strong>dir</strong> }目录下一个文件夹</p>
</li>
<li>
<p><strong>table</strong> ：在 <strong>hdfs</strong> 中表现所属*db* 目录下一个文件夹</p>
</li>
<li>
<p><strong>external table</strong> ：外部表, 与*table* 类似，不过其数据存放位置可以在任意指定路径
普通表: 删除表后, <strong>hdfs</strong> 上的文件都删了</p>
</li>
<li>
<p><strong>External</strong> 外部表删除后, <strong>hdfs</strong> 上的文件没有删除, 只是把文件删除了</p>
</li>
<li>
<p><strong>partition</strong> ：在 <strong>hdfs</strong> 中表现为 <strong>table</strong> 目录下的子目录</p>
</li>
<li>
<p><strong>bucket</strong> ：桶, 在 <strong>hdfs</strong> 中表现为同一个表目录下根据 <strong>hash</strong> 散列之后的多个文件, 会根据不同的文件把数据放到不同的文件中</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__strong_hive_strong_的安装部署">6. <strong>HIVE</strong> 的安装部署</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="/post/bigdata/hadoop/hive">hive 安装</a></p>
</div>
<div class="sect2">
<h3 id="_使用方式">6.1. 使用方式</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hive交互shell</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>bin/hive</code></pre>
</div>
</div>
</li>
<li>
<p>Hive thrift服务</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>启动方式，（假如是在hadoop01上）</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">启动为前台 </dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>bin/hiveserver2</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">启动为后台 </dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>nohup bin/hiveserver2 1&gt;/var/log/hiveserver.log 2&gt;/var/log/hiveserver.err &amp;</code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>启动成功后，可以在别的节点上用beeline去连接</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">方式（1）</dt>
<dd>
<p><code>hive/bin/beeline</code>  回车，进入beeline的命令界面<br>
输入命令连接 <code>hiveserver2</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>beeline&gt; !connect jdbc:hive2//mini1:10000</code></pre>
</div>
</div>
<div class="paragraph">
<p>（hadoop01是hiveserver2所启动的那台主机名，端口默认是10000）</p>
</div>
</dd>
<dt class="hdlist1">方式（2） </dt>
<dd>
<p>或者启动就连接：</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>bin/beeline -u jdbc:hive2://mini1:10000 -n hadoop</code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>接下来就可以做正常sql查询了</p>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hive基本操作">7. Hive基本操作</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ddl操作">7.1. DDL操作</h3>
<div class="sect3">
<h4 id="_创建表">7.1.1. 创建表</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">建表语法</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>CREATE [EXTERNAL] TABLE [IF NOT EXISTS] table_name
   [(col_name data_type [COMMENT col_comment], ...)]
   [COMMENT table_comment]
   [PARTITIONED BY (col_name data_type [COMMENT col_comment], ...)]
   [CLUSTERED BY (col_name, col_name, ...)
   [SORTED BY (col_name [ASC|DESC], ...)] INTO num_buckets BUCKETS]
   [ROW FORMAT row_format]
   [STORED AS file_format]
   [LOCATION hdfs_path]</code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>说明：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>CREATE</strong> <strong>TABLE</strong> 创建一个指定名字的表。如果相同名字的表已经存在，则抛出异常；用户可以用 <strong>IF</strong> <strong>NOT</strong> <strong>EXISTS</strong> 选项来忽略这个异常。</p>
</li>
<li>
<p><strong>EXTERNAL</strong> 关键字可以让用户创建一个外部表，在建表的同时指定一个指向实际数据的路径（<strong>LOCATION</strong>），<strong>Hive</strong> 创建内部表时，会将数据移动到数据仓库指向的路径；若创建外部表，仅记录数据所在的路径，不对数据的位置做任何改变。在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。</p>
</li>
<li>
<p><strong>LIKE</strong> 允许用户复制现有的表结构，但是不复制数据。</p>
</li>
<li>
<p><strong>ROW</strong> <strong>FORMAT</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>DELIMITED [FIELDS TERMINATED BY char] [COLLECTION ITEMS TERMINATED BY char] [MAP KEYS TERMINATED BY char] [LINES TERMINATED BY char]
| SERDE serde_name [WITH SERDEPROPERTIES (property_name=property_value, property_name=property_value, ...)]</code></pre>
</div>
</div>
<div class="paragraph">
<p>用户在建表的时候可以自定义 <strong>SerDe</strong> 或者使用自带的 <strong>SerDe</strong>。如果没有指定 <strong>ROW</strong> <strong>FORMAT</strong> 或者 <strong>ROW</strong> <strong>FORMAT</strong> <strong>DELIMITED</strong>，将会使用自带的 <strong>SerDe</strong>。在建表的时候，用户还需要为表指定列，用户在指定表的列的同时也会指定自定义的 <strong>SerDe</strong>，<strong>Hive*通过 *SerDe</strong> 确定表的具体的列的数据。</p>
</div>
</li>
<li>
<p><strong>STORED</strong> <strong>AS</strong>
<strong>SEQUENCEFILE</strong>|<strong>TEXTFILE</strong>|<strong>RCFILE</strong>
如果文件数据是纯文本，可以使用 <strong>STORED</strong> <strong>AS</strong> <strong>TEXTFILE</strong>。如果数据需要压缩，使用 <strong>STORED</strong> <strong>AS</strong> <strong>SEQUENCEFILE</strong>。</p>
</li>
<li>
<p><strong>CLUSTERED</strong> <strong>BY</strong>
对于每一个表（<strong>table</strong>）或者分区， <strong>Hive</strong> 可以进一步组织成桶，也就是说桶是更为细粒度的数据范围划分。<strong>Hive</strong> 也是 针对某一列进行桶的组织。<strong>Hive</strong> 采用对列值哈希，然后除以桶的个数求余的方式决定该条记录存放在哪个桶当中。
把表（或者分区）组织成桶（<strong>Bucket</strong>）有两个理由：</p>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>获得更高的查询处理效率。桶为表加上了额外的结构，<strong>Hive</strong> 在处理有些查询时能利用这个结构。具体而言，连接两个在（包含连接列的）相同列上划分了桶的表，可以使用 <strong>Map</strong> 端连接 （<strong>Map</strong>-<strong>side</strong> <strong>join</strong>）高效的实现。比如 <strong>JOIN</strong> 操作。对于 <strong>JOIN</strong> 操作两个表有一个相同的列，如果对这两个表都进行了桶操作。那么将保存相同列值的桶进行 <strong>JOIN</strong> 操作就可以，可以大大较少 <strong>JOIN</strong> 的数据量。</p>
</li>
<li>
<p>使取样（<strong>sampling</strong>）更高效。在处理大规模数据集时，在开发和修改查询的阶段，如果能在数据集的一小部分数据上试运行查询，会带来很多方便。</p>
</li>
</ol>
</div>
</div>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_具体实例">具体实例</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>创建内部表mytable</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image010.png" alt="image010">
</div>
</div>
<hr>
</li>
<li>
<p>创建外部表pageview</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image012.png" alt="image012">
</div>
</div>
<hr>
</li>
<li>
<p>创建分区表invites</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>create table student_p(Sno int,Sname string,Sex string,Sage int,Sdept string) partitioned by(part string) row format delimited fields terminated by ','stored as textfile;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image014.png" alt="image014">
</div>
</div>
<hr>
</li>
<li>
<p>创建带桶的表student</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image016.png" alt="image016">
</div>
</div>
<hr>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_修改表">7.1.2. 修改表</h4>
<div class="sect4">
<h5 id="_增加_删除分区">增加/删除分区</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>ALTER TABLE table_name ADD [IF NOT EXISTS] partition_spec [ LOCATION 'location1' ] partition_spec [ LOCATION 'location2' ] ...
partition_spec:
: PARTITION (partition_col = partition_col_value, partition_col = partiton_col_value, ...)

ALTER TABLE table_name DROP partition_spec, partition_spec,...</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>alter table student_p add partition(part='a') partition(part='b');</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image018.png" alt="image018">
</div>
</div>
<hr>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image020.png" alt="image020">
</div>
</div>
<hr>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_重命名表">重命名表</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>ALTER TABLE table_name RENAME TO new_table_name</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image022.png" alt="image022">
</div>
</div>
<hr>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_增加_更新列">增加/更新列</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>ALTER TABLE table_name ADD|REPLACE COLUMNS (col_name data_type [COMMENT col_comment], ...)</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>注：ADD是代表新增一字段，字段位置在所有列后面(partition列前)，REPLACE则是表示替换表中所有字段。</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>ALTER TABLE table_name CHANGE [COLUMN] col_old_name col_new_name column_type [COMMENT col_comment] [FIRST|AFTER column_name]</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image024.png" alt="image024">
</div>
</div>
<hr>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_显示命令">显示命令</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>show tables
show databases
show partitions
show functions
desc extended t_name;
desc formatted table_name;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dml操作">7.1.3. DML操作</h4>
<div class="sect4">
<h5 id="_load">Load</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>LOAD DATA [LOCAL] INPATH 'filepath' [OVERWRITE] INTO
TABLE tablename [PARTITION (partcol1=val1, partcol2=val2 ...)]</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">说明</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load 操作只是单纯的复制/移动操作，将数据文件移动到 Hive 表对应的位置。</p>
</li>
<li>
<p>filepath</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>相对路径，例如：<strong>project/data1</strong><br>
绝对路径，例如：<strong>/user/hive/project/data1</strong><br>
包含模式的完整 URI，列如：+
<strong>hdfs://namenode:9000/user/hive/project/data1</strong></p>
</div>
</div>
</div>
</li>
<li>
<p>LOCAL关键字</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>如果指定了 LOCAL， load 命令会去查找本地文件系统中的 filepath。<br>
如果没有指定 LOCAL 关键字，则根据inpath中的uri 查找文件</p>
</div>
</div>
</div>
</li>
<li>
<p>OVERWRITE 关键字</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>如果使用了 OVERWRITE 关键字，则目标表（或者分区）中的内容会被删除，然后再将 filepath 指向的文件/目录中的内容添加到表/分区中。<br>
如果目标表（分区）已经有一个文件，并且文件名和 filepath 中的文件名冲突，那么现有的文件会被新文件所替代。</p>
</div>
</div>
</div>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>加载相对路径数据</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image026.png" alt="image026">
</div>
</div>
<hr>
</li>
<li>
<p>加载绝对路径数据</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image028.png" alt="image028">
</div>
</div>
<hr>
</li>
<li>
<p>加载包含模式数据</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image030.png" alt="image030">
</div>
</div>
<hr>
</li>
<li>
<p>OVERWRITE关键字使用</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image032.png" alt="image032">
</div>
</div>
<hr>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_insert">Insert</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>INSERT OVERWRITE TABLE tablename1 [PARTITION (partcol1=val1, partcol2=val2 ...)] select_statement1 FROM from_statement

Multiple inserts:
FROM from_statement
INSERT OVERWRITE TABLE tablename1 [PARTITION (partcol1=val1, partcol2=val2 ...)] select_statement1
[INSERT OVERWRITE TABLE tablename2 [PARTITION ...] select_statement2] ...

Dynamic partition inserts:
INSERT OVERWRITE TABLE tablename PARTITION (partcol1[=val1], partcol2[=val2] ...) select_statement FROM from_statement</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>基本模式插入</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image034.png" alt="image034">
</div>
</div>
<hr>
</li>
<li>
<p>多插入模式</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image036.png" alt="image036">
</div>
</div>
<hr>
</li>
<li>
<p>自动分区模式</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image038.png" alt="image038">
</div>
</div>
<hr>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="sect5">
<h6 id="_导出表数据">导出表数据</h6>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>INSERT OVERWRITE [LOCAL] DIRECTORY directory1 SELECT ... FROM ...


multiple inserts:
FROM from_statement
INSERT OVERWRITE [LOCAL] DIRECTORY directory1 select_statement1
[INSERT OVERWRITE [LOCAL] DIRECTORY directory2 select_statement2] ...</code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>导出文件到本地</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image040.png" alt="image040">
</div>
</div>
<hr>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>说明：
数据写入到文件系统时进行文本序列化，且每列用^A来区分，\n为换行符。用more命令查看时不容易看出分割符，可以使用:sed -e 's/\x01/|/g' filename 来查看。</p>
</div>
</blockquote>
</div>
</li>
<li>
<p>导出数据到HDFS</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image042.png" alt="image042">
</div>
</div>
<hr>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_select">SELECT</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>SELECT [ALL | DISTINCT] select_expr, select_expr, ...
FROM table_reference
[WHERE where_condition]
[GROUP BY col_list [HAVING condition]]
[CLUSTER BY col_list
  | [DISTRIBUTE BY col_list] [SORT BY| ORDER BY col_list]
]
[LIMIT number]</code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>注：
. order by 会对输入做全局排序，因此只有一个reducer，会导致当输入规模较大时，需要较长的计算时间。
. sort by不是全局排序，其在数据进入reducer前完成排序。因此，如果用sort by进行排序，并且设置mapred.reduce.tasks&gt;1，则sort by只保证每个reducer的输出有序，不保证全局有序。
. distribute by根据distribute by指定的内容将数据分到同一个reducer。
. Cluster by 除了具有Distribute by的功能外，还会对该字段进行排序。因此，常常认为cluster by = distribute by + sort by</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">具体实例</dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>获取年龄大的3个学生</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image044.png" alt="image044">
</div>
</div>
<hr>
</li>
<li>
<p>查询学生信息按年龄，降序排序</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image046.png" alt="image046">
</div>
</div>
<hr>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image048.png" alt="image048">
</div>
</div>
<hr>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image050.png" alt="image050">
</div>
</div>
<hr>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image052.png" alt="image052">
</div>
</div>
<hr>
</li>
<li>
<p>按学生名称汇总学生年龄</p>
<div class="imageblock">
<div class="content">
<img src="http://dishui.oschina.io/note-hugo/src/img/hadoop/image0.png" alt="image0">
</div>
</div>
<hr>
</li>
</ol>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hive_join">7.1.4. Hive Join</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">语法结构</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>join_table:
  table_reference JOIN table_factor [join_condition]
  | table_reference {LEFT|RIGHT|FULL} [OUTER] JOIN table_reference join_condition
  | table_reference LEFT SEMI JOIN table_reference join_condition</code></pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Hive 支持等值连接（equality joins）、外连接（outer joins）和（left/right joins）。Hive 不支持非等值的连接，因为非等值连接非常难转化到 map/reduce 任务。
另外，Hive 支持多于 2 个表的连接。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>写 join 查询时，需要注意几个关键点：
1. 只支持等值join
例如：</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>  SELECT a.* FROM a JOIN b ON (a.id = b.id)
  SELECT a.* FROM a JOIN b
    ON (a.id = b.id AND a.department = b.department)
是正确的，然而:
  SELECT a.* FROM a JOIN b ON (a.id&gt;b.id)
是错误的。</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>可以 join 多于 2 个表。
例如
  SELECT a.val, b.val, c.val FROM a JOIN b
    ON (a.key = b.key1) JOIN c ON (c.key = b.key2)
如果join中多个表的 join key 是同一个，则 join 会被转化为单个 map/reduce 任务，例如：
  SELECT a.val, b.val, c.val FROM a JOIN b
    ON (a.key = b.key1) JOIN c
    ON (c.key = b.key1)
被转化为单个 map/reduce 任务，因为 join 中只使用了 b.key1 作为 join key。
SELECT a.val, b.val, c.val FROM a JOIN b ON (a.key = b.key1)
  JOIN c ON (c.key = b.key2)
而这一 join 被转化为 2 个 map/reduce 任务。因为 b.key1 用于第一次 join 条件，而 b.key2 用于第二次 join。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>3．join 时，每次 map/reduce 任务的逻辑：
    reducer 会缓存 join 序列中除了最后一个表的所有表的记录，再通过最后一个表将结果序列化到文件系统。这一实现有助于在 reduce 端减少内存的使用量。实践中，应该把最大的那个表写在最后（否则会因为缓存浪费大量内存）。例如：
SELECT a.val, b.val, c.val FROM a
    JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key1)
所有表都使用同一个 join key（使用 1 次 map/reduce 任务计算）。Reduce 端会缓存 a 表和 b 表的记录，然后每次取得一个 c 表的记录就计算一次 join 结果，类似的还有：
  SELECT a.val, b.val, c.val FROM a
    JOIN b ON (a.key = b.key1) JOIN c ON (c.key = b.key2)
这里用了 2 次 map/reduce 任务。第一次缓存 a 表，用 b 表序列化；第二次缓存第一次 map/reduce 任务的结果，然后用 c 表序列化。</p>
</div>
<div class="paragraph">
<p>4．LEFT，RIGHT 和 FULL OUTER 关键字用于处理 join 中空记录的情况
例如：
  SELECT a.val, b.val FROM
a LEFT OUTER JOIN b ON (a.key=b.key)
对应所有 a 表中的记录都有一条记录输出。输出的结果应该是 a.val, b.val，当 a.key=b.key 时，而当 b.key 中找不到等值的 a.key 记录时也会输出:
a.val, NULL
所以 a 表中的所有记录都被保留了；
“a RIGHT OUTER JOIN b”会保留所有 b 表的记录。</p>
</div>
<div class="paragraph">
<p>Join 发生在 WHERE 子句之前。如果你想限制 join 的输出，应该在 WHERE 子句中写过滤条件——或是在 join 子句中写。这里面一个容易混淆的问题是表分区的情况：
  SELECT a.val, b.val FROM a
  LEFT OUTER JOIN b ON (a.key=b.key)
  WHERE a.ds='2009-07-07' AND b.ds='2009-07-07'
会 join a 表到 b 表（OUTER JOIN），列出 a.val 和 b.val 的记录。WHERE 从句中可以使用其他列作为过滤条件。但是，如前所述，如果 b 表中找不到对应 a 表的记录，b 表的所有列都会列出 NULL，包括 ds 列。也就是说，join 会过滤 b 表中不能找到匹配 a 表 join key 的所有记录。这样的话，LEFT OUTER 就使得查询结果与 WHERE 子句无关了。解决的办法是在 OUTER JOIN 时使用以下语法：
  SELECT a.val, b.val FROM a LEFT OUTER JOIN b
  ON (a.key=b.key AND
      b.ds='2009-07-07' AND
      a.ds='2009-07-07')
这一查询的结果是预先在 join 阶段过滤过的，所以不会存在上述问题。这一逻辑也可以应用于 RIGHT 和 FULL 类型的 join 中。</p>
</div>
</div>
</div>
</div>
</div>

		</div>
		
	</article>
	
<div class="mr-author-box clearfix">
	<figure class="mr-author-box-avatar">
		<img alt="dishui avatar" src="http://dishui.oschina.io/note-hugo/src/img/dishui.png" class="avatar avatar-90 photo" height="90" width="90">
	</figure>
	<div class="mr-author-box-header">
		<span class="mr-author-box-name">About dishui</span>
	</div>
	<div class="mr-author-box-bio">
		辛勤的搬运工!!!
	</div>
</div>

	

	<nav class="mr-post-nav mr-row clearfix" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
		
		
		<div class="mr-col-1-2 mr-post-nav-item mr-post-nav-next">
			<a href="http://dishui.oschina.io/note-hugo/post/bigdata/hadoop/hive/" rel="next"><span>Next»</span><p>hive</p></a>
		</div>
		
	</nav>


	
</div>

<aside class="mr-sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
<div class="mr-widget widget_search navbar-wrapper" >
    <form class="search-form" role="search" >
        <label>
            <span class="screen-reader-text">Search for:</span>
            <input id="lanren" type="search" class="search-field" placeholder="Search..." value="" name="q">
        </label>
        <div id="list-container" class="bdsug" style="height: auto; display: block;">
        </div>
    </form>
    <div id="side-toc" class="entry-content">
    
    </div>
</div>
</aside>
	</div>
		<div class="mr-copyright-wrap">
			<div class="mr-container mr-container-inner clearfix">
				<p class="mr-copyright">&copy; 2017 工作笔记. Based on <a href="//wordpress.org/themes/mh-magazine-lite/" target="_blank" rel="nofollow noopener noreferrer">MH Magazine lite</a>.</p>
			</div>
		</div>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>



</body>
</html>